<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';">
    <title>Pol√≠gono Vocal Remover</title>
    <style>
        :root {
            --color-bg: #141414;
            --color-surface: #1a1a1a;
            --color-border: #2a2a2a;
            --color-text: #ffffff;
            --color-text-muted: #9e9e9e;
            --color-primary: #D9052E;
            --color-primary-hover: #ff1c45;
            --color-success: #4caf50;
            --color-warning: #ff9800;
            --color-error: #f44336;
            --color-pending: #616161;
            --color-processing: #2196f3;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--color-border);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            color: var(--color-text-muted);
            font-size: 14px;
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
        }

        /* Left Panel - Global Settings */
        .panel-settings {
            width: 320px;
            background: var(--color-surface);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--color-text-muted);
            margin-bottom: 5px;
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--color-border);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--color-bg);
        }

        .drop-zone:hover {
            border-color: var(--color-primary);
            background: rgba(217, 5, 46, 0.05);
        }

        .drop-zone.drag-over {
            border-color: var(--color-primary);
            background: rgba(217, 5, 46, 0.1);
            transform: scale(1.02);
        }

        .drop-zone-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .drop-zone-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .drop-zone-hint {
            font-size: 12px;
            color: var(--color-text-muted);
        }

        /* Options */
        .option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .option-label {
            font-size: 13px;
            color: var(--color-text-muted);
        }

        .option-select {
            padding: 10px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text);
            font-size: 14px;
            cursor: pointer;
        }

        .option-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--color-text-muted);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--color-border);
            color: var(--color-text);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Advanced Settings Collapsible */
        .advanced-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 0;
            transition: color 0.2s;
        }

        .advanced-header:hover {
            color: var(--color-primary);
        }

        .advanced-arrow {
            transition: transform 0.3s ease;
        }

        .advanced-arrow.open {
            transform: rotate(90deg);
        }

        .advanced-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .advanced-content.open {
            max-height: 300px;
        }

        /* Right Panel - Queue */
        .panel-queue {
            flex: 1;
            background: var(--color-surface);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .queue-stats {
            font-size: 13px;
            color: var(--color-text-muted);
        }

        .queue-actions {
            display: flex;
            gap: 10px;
        }

        /* Job List */
        .job-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .job-list:empty::before {
            content: 'No files in queue. Drop or select files to begin.';
            display: block;
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-muted);
            font-size: 14px;
        }

        /* Job Item */
        .job-item {
            background: var(--color-bg);
            border-radius: 6px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 4px solid var(--color-pending);
            transition: all 0.2s ease;
        }

        .job-item.pending {
            border-left-color: var(--color-pending);
        }

        .job-item.processing {
            border-left-color: var(--color-processing);
            background: rgba(33, 150, 243, 0.05);
        }

        .job-item.completed {
            border-left-color: var(--color-success);
        }

        .job-item.error {
            border-left-color: var(--color-error);
        }

        /* Job Status Icon */
        .job-status {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            background: var(--color-surface);
        }

        .job-item.pending .job-status {
            color: var(--color-pending);
        }

        .job-item.processing .job-status {
            color: var(--color-processing);
            animation: spin 2s linear infinite;
        }

        .job-item.completed .job-status {
            color: var(--color-success);
        }

        .job-item.error .job-status {
            color: var(--color-error);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Job Info */
        .job-info {
            flex: 1;
            min-width: 0;
        }

        .job-name {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 5px;
        }

        .job-meta {
            font-size: 11px;
            color: var(--color-text-muted);
            margin-bottom: 8px;
        }

        /* Job Progress Bar */
        .job-progress {
            height: 4px;
            background: var(--color-surface);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .job-progress-bar {
            height: 100%;
            background: var(--color-processing);
            width: 0%;
            transition: width 0.3s ease;
        }

        .job-item.completed .job-progress-bar {
            background: var(--color-success);
            width: 100%;
        }

        .job-item.error .job-progress-bar {
            background: var(--color-error);
        }

        .job-detail {
            font-size: 11px;
            color: var(--color-text-muted);
        }

        /* Job Actions */
        .job-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .job-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 4px;
            background: var(--color-surface);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .job-btn:hover {
            background: var(--color-border);
            color: var(--color-text);
        }

        .job-btn.remove:hover {
            background: var(--color-error);
            color: white;
        }

        .job-btn.open:hover {
            background: var(--color-success);
            color: white;
        }

        .job-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Console Log (collapsible) */
        .console-section {
            margin-top: 15px;
            border-top: 1px solid var(--color-border);
            padding-top: 15px;
        }

        .console-toggle {
            cursor: pointer;
            user-select: none;
            padding: 8px;
            margin: -8px;
            transition: color 0.2s;
        }

        .console-toggle:hover {
            color: var(--color-primary);
        }

        .console-log {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #0d0d0d;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            margin-top: 10px;
        }

        .console-log.open {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
        }

        .log-entry {
            padding: 2px 0;
            color: var(--color-text-muted);
        }

        .log-entry .log-level {
            color: var(--color-primary);
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üéµ Pol√≠gono Vocal Remover</h1>
        <p>AI-Powered Audio Separation - Batch Processing</p>
    </header>

    <main class="main">
        <!-- Settings Panel -->
        <aside class="panel-settings">
            <div class="section-title">Add Files</div>

            <div id="drop-zone" class="drop-zone">
                <div class="drop-zone-icon">üéµ</div>
                <div class="drop-zone-text">Drop Audio or Video Files</div>
                <div class="drop-zone-hint">Or click to browse (supports multiple files)</div>
            </div>

            <div class="section-title">Global Settings</div>

            <div class="option-group">
                <label class="option-label">Processing Mode</label>
                <select id="opt-mode" class="option-select">
                    <option value="vocal_remover">Vocal Remover (2 Tracks)</option>
                    <option value="splitter">Stem Splitter (4 Tracks)</option>
                </select>
            </div>

            <div class="option-group">
                <label class="option-label">Device</label>
                <select id="opt-device" class="option-select">
                    <option value="auto">Auto-detect</option>
                    <option value="cuda">GPU (CUDA)</option>
                    <option value="cpu">CPU Only</option>
                </select>
            </div>

            <div class="option-group">
                <label class="option-label">Output Format</label>
                <select id="opt-format" class="option-select">
                    <option value="wav">WAV (Lossless)</option>
                    <option value="flac">FLAC (Compressed Lossless)</option>
                    <option value="mp3">MP3 (Lossy)</option>
                </select>
            </div>

            <!-- Advanced Settings -->
            <div class="advanced-header" id="advanced-toggle">
                <span class="advanced-arrow">‚ñ∂</span>
                <span class="section-title" style="margin: 0;">Advanced Settings</span>
            </div>

            <div class="advanced-content" id="advanced-settings">
                <div class="option-group">
                    <label class="option-label">AI Model</label>
                    <select id="opt-model" class="option-select">
                        <option value="htdemucs_ft">Demucs v4 Fine-tuned (Best)</option>
                        <option value="htdemucs">Demucs v4 Standard</option>
                        <option value="mdx_extra">MDX-Net Extra (Fast)</option>
                    </select>
                </div>

                <div class="option-group">
                    <label class="option-label">Quality</label>
                    <select id="opt-quality" class="option-select">
                        <option value="fast">Fast (1 shift)</option>
                        <option value="hq" selected>High Quality (2 shifts)</option>
                        <option value="ultra">Ultra (5 shifts)</option>
                    </select>
                </div>
            </div>

            <div class="section-title" style="margin-top: 10px;">Queue Actions</div>

            <button id="btn-start-queue" class="btn btn-primary" disabled>
                ‚ñ∂Ô∏è Start Queue
            </button>

            <button id="btn-stop-queue" class="btn btn-secondary" disabled>
                ‚èπÔ∏è Stop Queue
            </button>

            <button id="btn-clear-completed" class="btn btn-secondary">
                üóëÔ∏è Clear Completed
            </button>
        </aside>

        <!-- Queue Panel -->
        <section class="panel-queue">
            <div class="queue-header">
                <div>
                    <div class="section-title">Job Queue</div>
                    <div class="queue-stats" id="queue-stats">
                        0 pending ¬∑ 0 processing ¬∑ 0 completed
                    </div>
                </div>
            </div>

            <div id="job-list" class="job-list">
                <!-- Job items will be inserted here dynamically -->
            </div>

            <!-- Console Log (Optional) -->
            <div class="console-section">
                <div class="section-title console-toggle" id="console-toggle">
                    Debug Log ‚ñº
                </div>
                <div id="console-log" class="console-log">
                    <!-- Log entries will be inserted here -->
                </div>
            </div>
        </section>
    </main>

    <script>
        const { ipcRenderer } = require('electron');
        const path = require('path');

        // =================================================================
        // State Management
        // =================================================================

        const state = {
            queue: [], // Array of job objects
            isProcessing: false,
            currentJobId: null,
            nextJobId: 1,
        };

        // Job states: 'pending', 'processing', 'completed', 'error'
        function createJob(fileInfo) {
            return {
                id: state.nextJobId++,
                file: fileInfo,
                status: 'pending',
                progress: 0,
                detail: 'Waiting...',
                error: null,
                outputPath: null,
            };
        }

        // =================================================================
        // DOM Elements
        // =================================================================

        const elements = {
            dropZone: document.getElementById('drop-zone'),
            jobList: document.getElementById('job-list'),
            queueStats: document.getElementById('queue-stats'),
            btnStartQueue: document.getElementById('btn-start-queue'),
            btnStopQueue: document.getElementById('btn-stop-queue'),
            btnClearCompleted: document.getElementById('btn-clear-completed'),
            optMode: document.getElementById('opt-mode'),
            optDevice: document.getElementById('opt-device'),
            optFormat: document.getElementById('opt-format'),
            optModel: document.getElementById('opt-model'),
            optQuality: document.getElementById('opt-quality'),
            advancedToggle: document.getElementById('advanced-toggle'),
            advancedSettings: document.getElementById('advanced-settings'),
            consoleToggle: document.getElementById('console-toggle'),
            consoleLog: document.getElementById('console-log'),
        };

        // =================================================================
        // UI Helpers
        // =================================================================

        function updateQueueStats() {
            const pending = state.queue.filter(j => j.status === 'pending').length;
            const processing = state.queue.filter(j => j.status === 'processing').length;
            const completed = state.queue.filter(j => j.status === 'completed').length;

            elements.queueStats.textContent =
                `${pending} pending ¬∑ ${processing} processing ¬∑ ${completed} completed`;

            // Update button states
            const hasPending = pending > 0 || processing > 0;
            elements.btnStartQueue.disabled = state.isProcessing || state.queue.length === 0;
            elements.btnStopQueue.disabled = !state.isProcessing;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
            return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'pending': return '‚è≥';
                case 'processing': return '‚öôÔ∏è';
                case 'completed': return '‚úÖ';
                case 'error': return '‚ùå';
                default: return '‚óè';
            }
        }

        function logConsole(message, level = 'info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="log-level">[${level}]</span> ${time} - ${message}`;
            elements.consoleLog.appendChild(entry);
            elements.consoleLog.scrollTop = elements.consoleLog.scrollHeight;
        }

        // =================================================================
        // Job Rendering
        // =================================================================

        function renderJob(job) {
            const existingItem = document.getElementById(`job-${job.id}`);

            const jobHtml = `
                <div class="job-status">
                    ${getStatusIcon(job.status)}
                </div>
                <div class="job-info">
                    <div class="job-name" title="${job.file.name}">${job.file.name}</div>
                    <div class="job-meta">
                        ${job.file.type.toUpperCase()} ¬∑ ${formatFileSize(job.file.size)} ¬∑ .${job.file.extension}
                    </div>
                    <div class="job-progress">
                        <div class="job-progress-bar" style="width: ${job.progress}%"></div>
                    </div>
                    <div class="job-detail">${job.detail}</div>
                </div>
                <div class="job-actions">
                    ${job.status === 'completed' ?
                        `<button class="job-btn open" title="Open folder" data-job-id="${job.id}" data-action="open">üìÇ</button>` :
                        ''}
                    ${job.status === 'pending' || job.status === 'error' || job.status === 'completed' ?
                        `<button class="job-btn remove" title="Remove" data-job-id="${job.id}" data-action="remove">‚úï</button>` :
                        ''}
                </div>
            `;

            if (existingItem) {
                existingItem.className = `job-item ${job.status}`;
                existingItem.innerHTML = jobHtml;
            } else {
                const item = document.createElement('div');
                item.id = `job-${job.id}`;
                item.className = `job-item ${job.status}`;
                item.innerHTML = jobHtml;
                elements.jobList.appendChild(item);
            }
        }

        function renderAllJobs() {
            elements.jobList.innerHTML = '';
            state.queue.forEach(job => renderJob(job));
            updateQueueStats();
        }

        function updateJob(jobId, updates) {
            const job = state.queue.find(j => j.id === jobId);
            if (job) {
                Object.assign(job, updates);
                renderJob(job);
                updateQueueStats();
            }
        }

        // =================================================================
        // File Handling
        // =================================================================

        async function addFiles(filePaths) {
            logConsole(`Adding ${filePaths.length} file(s) to queue...`);

            for (const filePath of filePaths) {
                const info = await ipcRenderer.invoke('file:getInfo', filePath);

                if (info.valid) {
                    const job = createJob(info);
                    state.queue.push(job);
                    renderJob(job);
                    logConsole(`Added: ${info.name}`);
                } else {
                    logConsole(`Invalid file: ${path.basename(filePath)} - ${info.reason}`, 'error');
                }
            }

            updateQueueStats();
        }

        // Drop Zone - Click to browse
        elements.dropZone.addEventListener('click', async () => {
            const filePaths = await ipcRenderer.invoke('dialog:openFile');
            if (filePaths) {
                // Handle both single file (string) and multiple files (array)
                const paths = Array.isArray(filePaths) ? filePaths : [filePaths];
                await addFiles(paths);
            }
        });

        // Drop Zone - Drag and drop
        elements.dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.dropZone.classList.add('drag-over');
        });

        elements.dropZone.addEventListener('dragleave', () => {
            elements.dropZone.classList.remove('drag-over');
        });

        elements.dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            elements.dropZone.classList.remove('drag-over');

            const files = Array.from(e.dataTransfer.files);
            const filePaths = files.map(f => f.path);

            if (filePaths.length > 0) {
                await addFiles(filePaths);
            }
        });

        // =================================================================
        // Queue Processing
        // =================================================================

        async function processQueue() {
            if (state.isProcessing) return;

            state.isProcessing = true;
            updateQueueStats();
            logConsole('Queue processing started');

            while (true) {
                // Find next pending job
                const job = state.queue.find(j => j.status === 'pending');

                if (!job) {
                    // No more pending jobs
                    break;
                }

                // Process this job
                state.currentJobId = job.id;
                updateJob(job.id, {
                    status: 'processing',
                    detail: 'Initializing...',
                    progress: 0
                });

                logConsole(`Processing: ${job.file.name}`);

                try {
                    // Get global settings
                    const options = {
                        mode: elements.optMode.value,
                        model: elements.optModel.value,
                        quality: elements.optQuality.value,
                        device: elements.optDevice.value,
                        outputFormat: elements.optFormat.value,
                    };

                    // Start motor
                    const result = await ipcRenderer.invoke('motor:start', {
                        inputPath: job.file.path,
                        outputDir: null, // Use same directory as input
                        options
                    });

                    if (!result.success) {
                        throw new Error(result.error || 'Unknown error');
                    }

                    // Wait for completion (motor events will update progress)
                    // The motor will send 'motor:success' or 'motor:error' event
                    // which will be handled by event listeners below

                    // Wait for job to finish (status changes from 'processing')
                    await new Promise((resolve) => {
                        const checkInterval = setInterval(() => {
                            const currentJob = state.queue.find(j => j.id === job.id);
                            if (currentJob && currentJob.status !== 'processing') {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 500);
                    });

                } catch (error) {
                    logConsole(`Error processing ${job.file.name}: ${error.message}`, 'error');
                    updateJob(job.id, {
                        status: 'error',
                        detail: `Error: ${error.message}`,
                        error: error.message,
                    });
                }

                state.currentJobId = null;

                // Check if we should stop (user clicked stop button)
                if (!state.isProcessing) {
                    break;
                }
            }

            state.isProcessing = false;
            updateQueueStats();
            logConsole('Queue processing finished');
        }

        // Start Queue
        elements.btnStartQueue.addEventListener('click', () => {
            processQueue();
        });

        // Stop Queue
        elements.btnStopQueue.addEventListener('click', async () => {
            logConsole('Stopping queue...');
            state.isProcessing = false;

            // Cancel current job
            if (state.currentJobId) {
                await ipcRenderer.invoke('motor:cancel');
            }

            updateQueueStats();
        });

        // Clear Completed Jobs
        elements.btnClearCompleted.addEventListener('click', () => {
            const before = state.queue.length;
            state.queue = state.queue.filter(j => j.status !== 'completed');
            const removed = before - state.queue.length;

            if (removed > 0) {
                logConsole(`Removed ${removed} completed job(s)`);
                renderAllJobs();
            }
        });

        // =================================================================
        // Job Actions (Remove, Open Folder)
        // =================================================================

        elements.jobList.addEventListener('click', async (e) => {
            const button = e.target.closest('.job-btn');
            if (!button) return;

            const jobId = parseInt(button.dataset.jobId);
            const action = button.dataset.action;
            const job = state.queue.find(j => j.id === jobId);

            if (!job) return;

            if (action === 'remove') {
                const index = state.queue.indexOf(job);
                state.queue.splice(index, 1);
                logConsole(`Removed job: ${job.file.name}`);
                renderAllJobs();
            } else if (action === 'open' && job.outputPath) {
                await ipcRenderer.invoke('shell:openPath', job.outputPath);
            }
        });

        // =================================================================
        // Motor Event Listeners
        // =================================================================

        ipcRenderer.on('motor:start', (event, data) => {
            if (state.currentJobId) {
                logConsole(`Motor started for job ${state.currentJobId}: ${data.model} on ${data.device}`);
            }
        });

        ipcRenderer.on('motor:step', (event, data) => {
            if (state.currentJobId) {
                updateJob(state.currentJobId, {
                    detail: `Step ${data.stepNumber}/${data.totalSteps}: ${data.step}`,
                });
            }
        });

        ipcRenderer.on('motor:progress', (event, data) => {
            if (state.currentJobId) {
                const progress = data.stepPercent || data.globalPercent || 0;
                updateJob(state.currentJobId, {
                    progress: Math.round(progress),
                    detail: data.detail || `Processing: ${Math.round(progress)}%`,
                });
            }
        });

        ipcRenderer.on('motor:log', (event, data) => {
            logConsole(data.message, data.level || 'info');
        });

        ipcRenderer.on('motor:warning', (event, data) => {
            logConsole(`‚ö†Ô∏è ${data.message}`, 'warn');
        });

        ipcRenderer.on('motor:error', (event, data) => {
            logConsole(`Error: ${data.message}`, 'error');

            if (data.fatal && state.currentJobId) {
                updateJob(state.currentJobId, {
                    status: 'error',
                    detail: `Error: ${data.message}`,
                    error: data.message,
                });
            }
        });

        ipcRenderer.on('motor:success', (event, data) => {
            if (state.currentJobId) {
                logConsole(`Job ${state.currentJobId} completed successfully`);

                // Get output path from first output file
                let outputPath = null;
                if (data.outputs) {
                    const firstOutput = Object.values(data.outputs)[0];
                    if (firstOutput) {
                        outputPath = path.dirname(firstOutput);
                    }
                }

                updateJob(state.currentJobId, {
                    status: 'completed',
                    progress: 100,
                    detail: `‚úÖ Completed in ${data.elapsedSeconds?.toFixed(1)}s`,
                    outputPath: outputPath,
                });
            }
        });

        ipcRenderer.on('motor:cancelled', (event, data) => {
            if (state.currentJobId) {
                logConsole(`Job ${state.currentJobId} cancelled`);
                updateJob(state.currentJobId, {
                    status: 'error',
                    detail: 'Cancelled by user',
                    error: 'Cancelled',
                });
            }
        });

        // =================================================================
        // Advanced Settings Toggle
        // =================================================================

        elements.advancedToggle.addEventListener('click', () => {
            const arrow = elements.advancedToggle.querySelector('.advanced-arrow');
            const isOpen = elements.advancedSettings.classList.toggle('open');
            arrow.classList.toggle('open', isOpen);
        });

        // =================================================================
        // Console Toggle
        // =================================================================

        elements.consoleToggle.addEventListener('click', () => {
            const isOpen = elements.consoleLog.classList.toggle('open');
            elements.consoleToggle.textContent = isOpen ? 'Debug Log ‚ñ≤' : 'Debug Log ‚ñº';
        });

        // =================================================================
        // Initialization
        // =================================================================

        logConsole('Queue system initialized');
        updateQueueStats();
    </script>
</body>
</html>
